name: Auto-create Agent PR

on:
  push:
    branches:
      - 'agent/**'

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  create-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract issue number from branch name
        id: extract
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT
          
          # Extract issue number from branch name (e.g., agent/123-description -> 123)
          ISSUE_NUM=$(echo "$BRANCH_NAME" | sed -n 's/^agent\/\([0-9]\+\)-.*/\1/p')
          echo "issue_number=$ISSUE_NUM" >> $GITHUB_OUTPUT
          
          # Create PR title from branch name
          TITLE=$(echo "$BRANCH_NAME" | sed 's/^agent\/[0-9]\+-//' | sed 's/-/ /g' | sed 's/\b\(.\)/\u\1/g')
          echo "title=[Agent Task] $TITLE" >> $GITHUB_OUTPUT

      - name: Check if PR already exists
        id: check-pr
        run: |
          BRANCH="${{ steps.extract.outputs.branch }}"
          PR_EXISTS=$(gh pr list --head "$BRANCH" --state open --json number --jq 'length')
          echo "exists=$PR_EXISTS" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Read PR template
        id: template
        if: steps.check-pr.outputs.exists == '0'
        run: |
          if [ -f ".github/PULL_REQUEST_TEMPLATE.md" ]; then
            TEMPLATE_CONTENT=$(cat .github/PULL_REQUEST_TEMPLATE.md)
          else
            TEMPLATE_CONTENT="## Agent PR Summary
          - Issue: Closes #${{ steps.extract.outputs.issue_number }}
          - Track: (specify A/B/C/D)
          - Agent: github-copilot / codex / pair
          
          ## Validation
          - [ ] Required checks passed
          - [ ] Rebased on latest \`main\` (automation also enforces this)
          - [ ] No unresolved conflicts with parallel tracks
          
          ## Auto-merge
          - [ ] Add label \`agent-automerge\` to allow automatic merge after checks + approval.
          
          ## Integration notes
          - Dependencies handled:
          - Conflict surface reviewed:
          - Follow-up tasks:"
          fi
          
          # Replace placeholder issue number if template has one
          if [ -n "${{ steps.extract.outputs.issue_number }}" ]; then
            TEMPLATE_CONTENT=$(echo "$TEMPLATE_CONTENT" | sed "s/<issue-number>/${{ steps.extract.outputs.issue_number }}/g")
          fi
          
          # Write to file to preserve multiline
          echo "$TEMPLATE_CONTENT" > /tmp/pr-body.md
          echo "body_file=/tmp/pr-body.md" >> $GITHUB_OUTPUT

      - name: Get commit message for body enhancement
        id: commit
        if: steps.check-pr.outputs.exists == '0'
        run: |
          LAST_COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "message<<EOF" >> $GITHUB_OUTPUT
          echo "$LAST_COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        id: create-pr
        if: steps.check-pr.outputs.exists == '0'
        run: |
          BODY=$(cat /tmp/pr-body.md)
          COMMIT_MSG="${{ steps.commit.outputs.message }}"
          
          # Enhance body with commit message if it contains useful info
          if echo "$COMMIT_MSG" | grep -q "Verification:"; then
            ENHANCED_BODY="$BODY

---

## Latest Commit
$COMMIT_MSG"
          else
            ENHANCED_BODY="$BODY"
          fi
          
          PR_URL=$(gh pr create \
            --title "${{ steps.extract.outputs.title }}" \
            --body "$ENHANCED_BODY" \
            --base main \
            --head "${{ steps.extract.outputs.branch }}" \
            --label "agent-task")
          
          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
          echo "âœ… Pull request created: $PR_URL"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Auto-add agent-automerge label if commit indicates
        if: steps.check-pr.outputs.exists == '0' && contains(steps.commit.outputs.message, '[automerge]')
        run: |
          gh pr edit "${{ steps.create-pr.outputs.pr_url }}" --add-label "agent-automerge"
          echo "âœ… Added agent-automerge label based on commit message"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on linked issue
        if: steps.check-pr.outputs.exists == '0' && steps.extract.outputs.issue_number != ''
        run: |
          gh issue comment "${{ steps.extract.outputs.issue_number }}" \
            --body "ðŸ¤– Automated PR created: ${{ steps.create-pr.outputs.pr_url }}

This PR was automatically generated from branch \`${{ steps.extract.outputs.branch }}\`.

The agent PR automation workflow will now:
- âœ“ Auto-rebase onto latest \`main\`
- âœ“ Auto-approve via \`github-actions[bot]\`
- âœ“ Enable auto-merge if \`agent-automerge\` label is present

Status: \`in-progress\` â†’ \`ready-for-review\`"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Summary
        if: steps.check-pr.outputs.exists == '0'
        run: |
          echo "## ðŸš€ Agent PR Auto-created!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** \`${{ steps.extract.outputs.branch }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Title:** ${{ steps.extract.outputs.title }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Issue:** #${{ steps.extract.outputs.issue_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **PR:** ${{ steps.create-pr.outputs.pr_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The PR automation workflow will handle rebase, approval, and merge." >> $GITHUB_STEP_SUMMARY

      - name: Skip - PR already exists
        if: steps.check-pr.outputs.exists != '0'
        run: |
          echo "â„¹ï¸ Pull request already exists for branch ${{ steps.extract.outputs.branch }}"
          echo "## â„¹ï¸ PR Already Exists" >> $GITHUB_STEP_SUMMARY
          echo "A pull request already exists for this branch. No action taken." >> $GITHUB_STEP_SUMMARY
