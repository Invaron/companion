name: Agent Orchestrator

on:
  schedule:
    # Run every 15 minutes
    - cron: '*/15 * * * *'
  workflow_dispatch:
    inputs:
      force:
        description: 'Force run even if already running'
        required: false
        default: 'false'

permissions:
  contents: write
  issues: read
  pull-requests: read

jobs:
  check-for-work:
    runs-on: ubuntu-latest
    outputs:
      has_work: ${{ steps.check.outputs.has_work }}
      issue_number: ${{ steps.check.outputs.issue_number }}
      issue_title: ${{ steps.check.outputs.issue_title }}
    steps:
      - name: Check for ready issues
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            // Get all open issues with agent-task label
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'agent-task',
              state: 'open',
              sort: 'created',
              direction: 'asc'
            });

            // Filter for issues that are ready (not blocked, not in progress)
            const readyIssues = issues.filter(issue => {
              const labels = issue.labels.map(l => typeof l === 'string' ? l : l.name);
              return !labels.includes('blocked') && !labels.includes('in-progress');
            });

            if (readyIssues.length === 0) {
              console.log('No ready issues found');
              core.setOutput('has_work', 'false');
              return;
            }

            // Pick the oldest ready issue
            const issue = readyIssues[0];
            console.log(`Found ready issue: #${issue.number} - ${issue.title}`);
            
            core.setOutput('has_work', 'true');
            core.setOutput('issue_number', issue.number.toString());
            core.setOutput('issue_title', issue.title);

  trigger-agent:
    needs: check-for-work
    if: needs.check-for-work.outputs.has_work == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger agent executor
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.AGENT_PAT }}
          script: |
            const issueNumber = ${{ needs.check-for-work.outputs.issue_number }};
            const issueTitle = '${{ needs.check-for-work.outputs.issue_title }}';
            
            console.log(`Triggering agent executor for issue #${issueNumber}`);
            
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'agent-executor.yml',
              ref: 'main',
              inputs: {
                issue_number: issueNumber.toString(),
                issue_title: issueTitle
              }
            });
            
            console.log('Agent executor triggered successfully');
